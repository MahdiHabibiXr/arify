{% extends "base.html" %}

{% block title %} Wall placement {% endblock %}

{% block head %}

    <meta charset="utf-8">
    <meta name="description" content="{{ nerf.title}} - ARify">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    {% load static %}

    <link type="text/css" href="{% static 'css/styles.css' %}" rel="stylesheet"/>
    <script src="https://widget.artplacer.com/js/script.js"></script>
{% endblock %}

{% block content %}

    <!-- <div class="card">
        <div class="card-body ">
            
            <a href="{% url 'home' %}" class="btn btn-primary">Back</a>
            {% if request.user.id == nerf.user_id %}
                <a href="{% url 'delete' nerf.id %}" class="btn btn-danger mb-10">Delete</a>
            {% endif %}
            

            <h3 class="mt-3">{{ title }}</h3>
            <small>Date created: {{ nerf.called_at }} </small><br>
            <small>Status: <strong>Completed</strong> </small>

        </div>
    </div> -->


{% endblock %}

{% block modelviewer %}
<artplacer gallery="51278" default_style="true" button_width="auto" resizable="false" frames="true" rotate="false" dimensions_standard="hxw" unit="cm" catalog="false" type="2" space="2481" text="test" artwork_url="dynamic url here" title="dynamic title here" size="dynamic size here" price="dynamic price here" artist="dynamic artist name here"></artplacer>

<!-- <div class="controls" id="color-controls">
    <h2>Desk Colors:</h2>
    <button class="btn" style="background-color: red;" data-color="1,0,0,1"></button>
    <button class="btn" style="background-color: blue;" data-color="0,0,1,1"></button>
    <button class="btn" style="background-color: yellow;" data-color="1,1,0,1"></button>
    <button class="btn" style="background-color: white;" data-color="1,1,1,1"></button>
</div>

<div class="controls" id="color-controls2">
    <h2>Desk Leg Colors:</h2>
    <button class="btn" style="background-color: #302d2a;" data-color="0.188,0.176,0.165,1"></button>
    <button class="btn" style="background-color: #382d25;" data-color="0.22,0.176,0.145,1"></button>
    <button class="btn" style="background-color: #b39472;" data-color="0.702,0.58,0.447,0.1"></button>
</div>
    <model-viewer id="model" src="{{model1}}" ar ar-placement="webxr scene-viewer quick-look" ar-modes="scene-viewer webxr quick-look" camera-controls poster="{{image1}}" camera-controls touch-action="pan-y" shadow-intensity="0"  field-of-view="30deg">
        <button slot="hotspot-dot+X-Y+Z" class="dot" data-position="1 -1 1" data-normal="1 0 0"></button>
        <button slot="hotspot-dim+X-Y" class="dim" data-position="1 -1 0" data-normal="1 0 0"></button>
        <button slot="hotspot-dot+X-Y-Z" class="dot" data-position="1 -1 -1" data-normal="1 0 0"></button>
        <button slot="hotspot-dim+X-Z" class="dim" data-position="1 0 -1" data-normal="1 0 0"></button>
        <button slot="hotspot-dot+X+Y-Z" class="dot" data-position="1 1 -1" data-normal="0 1 0"></button>
        <button slot="hotspot-dim+Y-Z" class="dim" data-position="0 -1 -1" data-normal="0 1 0"></button>
        <button slot="hotspot-dot-X+Y-Z" class="dot" data-position="-1 1 -1" data-normal="0 1 0"></button>
        <button slot="hotspot-dim-X-Z" class="dim" data-position="-1 0 -1" data-normal="-1 0 0"></button>
        <button slot="hotspot-dot-X-Y-Z" class="dot" data-position="-1 -1 -1" data-normal="-1 0 0"></button>
        <button slot="hotspot-dim-X-Y" class="dim" data-position="-1 -1 0" data-normal="-1 0 0"></button>
        <button slot="hotspot-dot-X-Y+Z" class="dot" data-position="-1 -1 1" data-normal="-1 0 0"></button>
        <svg id="dimLines" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" class="dimensionLineContainer">
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        <line class="dimensionLine"></line>
        </svg>
    
        <div id="controls" class="dim">
        <label for="src">Product:</label>
        <select id="src">
            <option value="{{model1}}">Chair</option>
            <option value="{{model2}}">Mixer</option>
            <option value="{{model3}}">Cactus</option>
        </select><br>
    
        <label for="show-dimensions">Show Dimensions:</label>
        <input id="show-dimensions" type="checkbox" checked="true">
        </div>
    </model-viewer>

    <script>
        const modelViewerTransform = document.querySelector("model-viewer#model");
    
        modelViewerTransform.orientation = `${20}deg ${0}deg ${0}deg`;
        //modelViewerTransform.updateFraming();


    </script>


    <script type="module">
        const modelViewerTexture1 = document.querySelector("model-viewer#model");
        
        modelViewerTexture1.addEventListener("load", () => {
        
            const material = modelViewerTexture1.model.materials[0];
            const material2 = modelViewerTexture1.model.materials[1];
        
            document.querySelector('#color-controls').addEventListener('click', (event) => {
                const colorString = event.target.dataset.color;
                if(!colorString){
                    return;
                }
            
                const color = colorString.split(',')
                    .map(numberString => parseFloat(numberString));
            
                console.log('changing color to: ', color);
                //const [material] = modelViewerColor.model.materials[0];
                console.log(material)
                material.pbrMetallicRoughness.setBaseColorFactor(color);
                material.pbrMetallicRoughness.setMetallicFactor(0);
            });
            document.querySelector('#color-controls2').addEventListener('click', (event) => {
                const colorString = event.target.dataset.color;
                if(!colorString){
                    return;
                }
            
                const color = colorString.split(',')
                    .map(numberString => parseFloat(numberString));
            
                console.log('changing color to: ', color);
                //const [material] = modelViewerColor.model.materials[0];
                console.log(material)
                material2.pbrMetallicRoughness.setBaseColorFactor(color);
            });
            document.querySelector('#color-controls').addEventListener('click', (event) => {
                const colorString = event.target.dataset.color;
                if(!colorString){
                    return;
                }
            
                const color = colorString.split(',')
                    .map(numberString => parseFloat(numberString));
            
                console.log('changing color to: ', color);
                //const [material] = modelViewerColor.model.materials[0];
                console.log(material)
                material.pbrMetallicRoughness.setBaseColorFactor(color);
                material.pbrMetallicRoughness.setMetallicFactor(0);
            });
        });
    </script>

    <script type="module">
    const modelViewer = document.querySelector('#model');

    modelViewer.querySelector('#src').addEventListener('input', (event) => {
    modelViewer.src = event.target.value;
    });

    const checkbox = modelViewer.querySelector('#show-dimensions');

    function setVisibility(element) {
    if (checkbox.checked) {
        element.classList.remove('hide');
    } else {
        element.classList.add('hide');
    }
    }

    checkbox.addEventListener('change', () => {
    setVisibility(modelViewer.querySelector('#dimLines'));
    modelViewer.querySelectorAll('button').forEach((hotspot) => {
        setVisibility(hotspot);
    });
    });

    // update svg
    function drawLine(svgLine, dotHotspot1, dotHotspot2, dimensionHotspot) {
    if (dotHotspot1 && dotHotspot2) {
        svgLine.setAttribute('x1', dotHotspot1.canvasPosition.x);
        svgLine.setAttribute('y1', dotHotspot1.canvasPosition.y);
        svgLine.setAttribute('x2', dotHotspot2.canvasPosition.x);
        svgLine.setAttribute('y2', dotHotspot2.canvasPosition.y);

        // use provided optional hotspot to tie visibility of this svg line to
        if (dimensionHotspot && !dimensionHotspot.facingCamera) {
        svgLine.classList.add('hide');
        }
        else {
        svgLine.classList.remove('hide');
        }
    }
    }

    const dimLines = modelViewer.querySelectorAll('line');

    const renderSVG = () => {
    drawLine(dimLines[0], modelViewer.queryHotspot('hotspot-dot+X-Y+Z'), modelViewer.queryHotspot('hotspot-dot+X-Y-Z'), modelViewer.queryHotspot('hotspot-dim+X-Y'));
    drawLine(dimLines[1], modelViewer.queryHotspot('hotspot-dot+X-Y-Z'), modelViewer.queryHotspot('hotspot-dot+X+Y-Z'), modelViewer.queryHotspot('hotspot-dim+X-Z'));
    drawLine(dimLines[2], modelViewer.queryHotspot('hotspot-dot+X+Y-Z'), modelViewer.queryHotspot('hotspot-dot-X+Y-Z')); // always visible
    drawLine(dimLines[3], modelViewer.queryHotspot('hotspot-dot-X+Y-Z'), modelViewer.queryHotspot('hotspot-dot-X-Y-Z'), modelViewer.queryHotspot('hotspot-dim-X-Z'));
    drawLine(dimLines[4], modelViewer.queryHotspot('hotspot-dot-X-Y-Z'), modelViewer.queryHotspot('hotspot-dot-X-Y+Z'), modelViewer.queryHotspot('hotspot-dim-X-Y'));
    };

    modelViewer.addEventListener('camera-change', renderSVG);

    modelViewer.addEventListener('load', () => {
    const center = modelViewer.getBoundingBoxCenter();
    const size = modelViewer.getDimensions();
    const x2 = size.x / 2;
    const y2 = size.y / 2;
    const z2 = size.z / 2;

    modelViewer.updateHotspot({
        name: 'hotspot-dot+X-Y+Z',
        position: `${center.x + x2} ${center.y - y2} ${center.z + z2}`
    });

    modelViewer.updateHotspot({
        name: 'hotspot-dim+X-Y',
        position: `${center.x + x2 * 1.2} ${center.y - y2 * 1.1} ${center.z}`
    });
    modelViewer.querySelector('button[slot="hotspot-dim+X-Y"]').textContent =
        `${(size.z * 100).toFixed(0)} cm`;

    modelViewer.updateHotspot({
        name: 'hotspot-dot+X-Y-Z',
        position: `${center.x + x2} ${center.y - y2} ${center.z - z2}`
    });

    modelViewer.updateHotspot({
        name: 'hotspot-dim+X-Z',
        position: `${center.x + x2 * 1.2} ${center.y} ${center.z - z2 * 1.2}`
    });
    modelViewer.querySelector('button[slot="hotspot-dim+X-Z"]').textContent =
        `${(size.y * 100).toFixed(0)} cm`;

    modelViewer.updateHotspot({
        name: 'hotspot-dot+X+Y-Z',
        position: `${center.x + x2} ${center.y + y2} ${center.z - z2}`
    });

    modelViewer.updateHotspot({
        name: 'hotspot-dim+Y-Z',
        position: `${center.x} ${center.y + y2 * 1.1} ${center.z - z2 * 1.1}`
    });
    modelViewer.querySelector('button[slot="hotspot-dim+Y-Z"]').textContent =
        `${(size.x * 100).toFixed(0)} cm`;

    modelViewer.updateHotspot({
        name: 'hotspot-dot-X+Y-Z',
        position: `${center.x - x2} ${center.y + y2} ${center.z - z2}`
    });

    modelViewer.updateHotspot({
        name: 'hotspot-dim-X-Z',
        position: `${center.x - x2 * 1.2} ${center.y} ${center.z - z2 * 1.2}`
    });
    modelViewer.querySelector('button[slot="hotspot-dim-X-Z"]').textContent =
        `${(size.y * 100).toFixed(0)} cm`;

    modelViewer.updateHotspot({
        name: 'hotspot-dot-X-Y-Z',
        position: `${center.x - x2} ${center.y - y2} ${center.z - z2}`
    });

    modelViewer.updateHotspot({
        name: 'hotspot-dim-X-Y',
        position: `${center.x - x2 * 1.2} ${center.y - y2 * 1.1} ${center.z}`
    });
    modelViewer.querySelector('button[slot="hotspot-dim-X-Y"]').textContent =
        `${(size.z * 100).toFixed(0)} cm`;

    modelViewer.updateHotspot({
        name: 'hotspot-dot-X-Y+Z',
        position: `${center.x - x2} ${center.y - y2} ${center.z + z2}`
    });

    renderSVG();
    });
    </script>
    <style>
        #controls {
        position: absolute;
        bottom: 16px;
        left: 16px;
        max-width: unset;
        transform: unset;
        pointer-events: auto;
        z-index: 100;
        }
    
        .dot{
        display: none;
        }
    
        .dim{
        background: #fff;
        border-radius: 4px;
        border: none;
        box-sizing: border-box;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
        color: rgba(0, 0, 0, 0.8);
        display: block;
        font-family: Futura, Helvetica Neue, sans-serif;
        font-size: 1em;
        font-weight: 700;
        max-width: 128px;
        overflow-wrap: break-word;
        padding: 0.5em 1em;
        position: absolute;
        width: max-content;
        height: max-content;
        transform: translate3d(-50%, -50%, 0);
        pointer-events: none;
        --min-hotspot-opacity: 0;
        }
    
        @media only screen and (max-width: 800px) {
        .dim{
            font-size: 3vw;
        }
        }
    
        .dimensionLineContainer{
        pointer-events: none;
        display: block;
        }
    
        .dimensionLine{
        stroke: #16a5e6;
        stroke-width: 2;
        stroke-dasharray: 2;
        }
    
        .hide{
        display: none;
        }
        /* This keeps child nodes hidden while the element loads */
        :not(:defined) > * {
        display: none;
        }
    </style>

    <script src="https://widget.artplacer.com/js/script.js"></script> -->

    <!-- <script src="{% static 'js/script.js' %}"></script> -->
    <!-- Loads <model-viewer> for browsers: -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.0.1/model-viewer.min.js"></script>

{% endblock %}
